<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clearwater Permit Search - Permit Data Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-slate-900 text-white">
  <main class="p-4 max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">Clearwater Permit Batch Search</h1>
    <textarea id="permitNumbersInput" class="w-full h-48 p-2 mb-4" placeholder="BCP2025-090286&#10;BCP2025-090510&#10;..."></textarea>
    <button id="generateBtn" class="bg-cyan-600 py-2 px-4 rounded hover:bg-cyan-500">Generate CSV</button>
    <div id="status" class="mt-4"></div>
    <button id="downloadBtn" class="hidden mt-2 bg-green-600 py-2 px-4 rounded hover:bg-green-500">Download CSV</button>
  </main>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const textarea = document.getElementById('permitNumbersInput');
    const statusEl = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadBtn');

    // Set your internal API endpoint here
    const webhookURL = '/api/generate-report';

    generateBtn.addEventListener('click', async () => {
      const rawInput = textarea.value.trim();
      if (!rawInput) {
        statusEl.textContent = 'Please enter at least one permit number.';
        return;
      }

      const permits = rawInput.split(/\r?\n/).map(p => p.trim()).filter(Boolean);
      statusEl.textContent = 'Submitting permits…';

      try {
        const url = `${webhookURL}?permitNumbers=${encodeURIComponent(permits.join('\n'))}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(await response.text() || 'Workflow request failed.');

        const blob = await response.blob();
        const downloadUrl = URL.createObjectURL(blob);

        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = 'permit_report.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(downloadUrl);
        };

        statusEl.textContent = '✅ Report ready. Click below to download.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error: ' + err.message;
      }
    });
  </script>
</body>
</html>
